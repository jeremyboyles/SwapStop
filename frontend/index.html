<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SwapStop — Simple Skeleton</title>
  <style>
    :root{--green:#22c55e;--black:#0b1220;--panel:#0f172a;--line:#1f2937;--text:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;background:var(--black);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
    a{color:var(--green);text-decoration:none}
    .header{position:sticky;top:0;background:#08101f;border-bottom:1px solid var(--line);padding:12px;display:flex;gap:12px;align-items:center}
    .btn{background:var(--green);color:#021014;border:0;padding:8px 12px;border-radius:6px;cursor:pointer}
    .wrap{padding:24px}
    /* modal / iframe */
    .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999}
    .modal{width:90%;max-width:900px;height:80%;background:var(--panel);border-radius:8px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,0.6);display:flex;flex-direction:column}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent)}
    .modal-iframe{flex:1;border:0;width:100%}
    .close-btn{background:transparent;border:0;color:var(--text);font-size:18px;cursor:pointer;padding:4px 8px}
  </style>
</head>
<body>
  <div class="header">
    <div style="font-weight:600">SwapStop</div>
    <button id="openChat" class="btn">Open Chat</button>
  </div>

  <div class="wrap">
    <!-- HOME (skeleton cards; feel like your doc’s mock) -->
    <section id="tab-home">
      <div class="card">
        <h2>Home Feed</h2>
        <p class="muted">Newest listings (sample placeholders to match the look; wire up later if you add a home endpoint).</p>
      </div>
      <div class="grid" id="homeGrid"></div>
    </section>

    <!-- USERS (matches existing endpoints) -->
    <section id="tab-users" class="hidden">
      <div class="card">
        <h2>Users</h2>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label>Username</label><input id="u-username" placeholder="alice"/>
          </div>
          <div>
            <label>Email</label><input id="u-email" placeholder="alice@example.com"/>
          </div>
        </div>
        <label>Password</label><input id="u-password" type="password" placeholder="••••••••"/>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btn-create-user">Create User</button>
          <span id="userMsg" class="muted"></span>
        </div>
      </div>

      <div class="card">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div><label>Skip</label><input id="u-skip" type="number" value="0"/></div>
          <div><label>Limit</label><input id="u-limit" type="number" value="10"/></div>
        </div>
        <div style="margin-top:10px"><button class="btn outline" id="btn-load-users">Load Users</button></div>
        <table id="usersTable" style="margin-top:10px">
          <thead><tr><th>ID</th><th>Username</th><th>Email</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h3>Create Item for Selected User</h3>
        <label>User</label>
        <select id="sel-user"><option value="">— pick user —</option></select>
        <label>Name</label><input id="i-name" placeholder="Nintendo Switch"/>
        <label>Description</label><textarea id="i-desc" placeholder="Neon Red/Blue, great condition"></textarea>
        <label>Price Estimate (optional)</label><input id="i-price" type="number" step="0.01" placeholder="199.99"/>
        <div style="margin-top:10px"><button class="btn" id="btn-create-item">Add Item</button></div>
        <div id="itemMsg" class="muted" style="margin-top:6px"></div>
      </div>

      <div class="card">
        <h3>User’s Items</h3>
        <label>User</label>
        <select id="sel-user-items"><option value="">— pick user —</option></select>
        <div style="margin-top:10px"><button class="btn outline" id="btn-load-user-items">Load Items</button></div>
        <table id="userItemsTable" style="margin-top:10px">
          <thead><tr><th>ID</th><th>Name</th><th>Price</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ITEMS (global) -->
    <section id="tab-items" class="hidden">
      <div class="card">
        <h2>All Items</h2>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div><label>Skip</label><input id="g-skip" type="number" value="0"/></div>
          <div><label>Limit</label><input id="g-limit" type="number" value="100"/></div>
        </div>
        <div style="margin-top:10px"><button class="btn outline" id="btn-load-items">Load</button></div>
      </div>

      <div class="grid" id="itemsGrid"></div>
    </section>

    <div class="card"><pre id="status" class="muted" style="white-space:pre-wrap"></pre></div>
    <div class="muted" style="text-align:center;opacity:.7">© 2025 SwapStop — Simple Skeleton</div>
  </div>

  <!-- modal that will load chat.html in an iframe -->
  <div id="chatModal" class="modal-backdrop" role="dialog" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-header">
        <div style="font-weight:600">Chat</div>
        <div>
          <button id="closeChat" class="close-btn" aria-label="Close">✕</button>
        </div>
      </div>
      <iframe id="chatFrame" class="modal-iframe" src="" title="Chat"></iframe>
    </div>
  </div>

  <script>
    // ==== CONFIG (same origin recommended) ====
    const API = ""; // leave empty to use same-origin; otherwise set like "http://127.0.0.1:8000"

    // ==== SIMPLE TABS ====
    const tabs = ["home","users","items"];
    function showTab(id){
      tabs.forEach(t=>{
        document.getElementById("tab-"+t).classList.toggle("hidden", t!==id);
        document.querySelector(`[data-tab="${t}"]`).classList.toggle("active", t===id);
      });
    }
    document.querySelectorAll(".nav button[data-tab]").forEach(btn=>{
      btn.addEventListener("click", ()=>showTab(btn.dataset.tab));
    });

    // ==== STATUS ====
    const statusEl = document.getElementById("status");
    const setStatus = (msg) => statusEl.textContent = msg || "";

    // ==== HELPERS ====
    async function api(path, opts={}){
      const res = await fetch((API||"") + path, {
        headers: { "Content-Type": "application/json" },
        ...opts
      });
      if(!res.ok){
        let body = "";
        try{ body = await res.json(); } catch{ body = await res.text(); }
        throw new Error(`[${res.status}] ${typeof body === "string" ? body : JSON.stringify(body)}`);
      }
      const txt = await res.text();
      try{ return txt ? JSON.parse(txt) : null; } catch{ return txt; }
    }

    // ==== HOME (placeholder cards to match style) ====
    function fillHome(){
      const grid = document.getElementById("homeGrid");
      grid.innerHTML = "";
      for(let i=0;i<6;i++){
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="thumb"></div>
          <div style="font-weight:800">Sample Item ${i+1}</div>
          <div>$${(99+i).toFixed(2)} <span class="badge">cash</span></div>
          <div class="muted" style="margin:6px 0">Short description...</div>
          <div style="display:flex;gap:8px">
            <button class="btn">View</button>
            <button class="btn outline">Save</button>
          </div>`;
        grid.appendChild(card);
      }
    }

    // ==== USERS ====
    async function loadUsers(){
      const skip = Number(document.getElementById("u-skip").value || 0);
      const limit = Number(document.getElementById("u-limit").value || 10);
      const users = await api(`/users/?skip=${skip}&limit=${limit}`);
      const tbody = document.querySelector("#usersTable tbody");
      const selA = document.getElementById("sel-user");
      const selB = document.getElementById("sel-user-items");
      tbody.innerHTML = ""; selA.innerHTML = `<option value="">— pick user —</option>`; selB.innerHTML = selA.innerHTML;
      for(const u of users){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.id}</td><td>${u.username}</td><td>${u.email}</td>
          <td><button class="btn outline" data-del-user="${u.id}">Delete</button></td>`;
        tbody.appendChild(tr);
        const opt = new Option(`${u.username} (#${u.id})`, u.id);
        selA.add(opt.cloneNode(true)); selB.add(opt.cloneNode(true));
      }
    }

    async function createUser(){
      const username = document.getElementById("u-username").value.trim();
      const email = document.getElementById("u-email").value.trim();
      const password = document.getElementById("u-password").value;
      const msg = document.getElementById("userMsg");
      if(!username || !email || !password){ msg.textContent = "All fields required."; return; }
      try{
        await api("/users/", { method:"POST", body: JSON.stringify({ username, email, password }) });
        msg.textContent = "User created.";
        await loadUsers();
      }catch(e){ msg.textContent = e.message; }
    }

    async function deleteUser(id){
      if(!confirm(`Delete user #${id}? This also deletes their items.`)) return;
      try{
        await api(`/users/${id}`, { method:"DELETE" });
        setStatus(`Deleted user ${id}`);
        await loadUsers();
      }catch(e){ setStatus(e.message); }
    }

    // ==== ITEMS ====
    async function createItem(){
      const userId = document.getElementById("sel-user").value;
      const name = document.getElementById("i-name").value.trim();
      const description = document.getElementById("i-desc").value.trim();
      const price = document.getElementById("i-price").value ? Number(document.getElementById("i-price").value) : null;
      const msg = document.getElementById("itemMsg");
      if(!userId){ msg.textContent = "Pick a user first."; return; }
      if(!name){ msg.textContent = "Item name required."; return; }
      try{
        await api(`/users/${userId}/items/`, { method:"POST", body: JSON.stringify({ name, description: description||null, price_estimate: price }) });
        msg.textContent = "Item created.";
        await loadUserItems();
      }catch(e){ msg.textContent = e.message; }
    }

    async function loadUserItems(){
      const userId = document.getElementById("sel-user-items").value;
      if(!userId){ setStatus("Pick a user."); return; }
      const items = await api(`/users/${userId}/items/`);
      const tbody = document.querySelector("#userItemsTable tbody");
      tbody.innerHTML = "";
      for(const it of items){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${it.id}</td><td>${it.name}</td><td>${it.price_estimate ?? ""}</td>
          <td><button class="btn outline" data-del-item="${it.id}">Delete</button></td>`;
        tbody.appendChild(tr);
      }
    }

    async function loadGlobalItems(){
      const skip = Number(document.getElementById("g-skip").value || 0);
      const limit = Number(document.getElementById("g-limit").value || 100);
      const items = await api(`/items/?skip=${skip}&limit=${limit}`);
      const grid = document.getElementById("itemsGrid");
      grid.innerHTML = "";
      for(const it of items){
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="thumb"></div>
          <div style="font-weight:800">${it.name}</div>
          <div>$${(it.price_estimate ?? 0).toFixed(2)} <span class="badge">owner #${it.owner_id}</span></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn outline" data-del-item="${it.id}">Delete</button>
          </div>`;
        grid.appendChild(card);
      }
    }

    // ==== EVENTS (delegated) ====
    document.addEventListener("click", (e)=>{
      const delUser = e.target.getAttribute && e.target.getAttribute("data-del-user");
      const delItem = e.target.getAttribute && e.target.getAttribute("data-del-item");
      if(delUser) deleteUser(Number(delUser));
      if(delItem) { if(confirm(`Delete item #${delItem}?`)) api(`/items/${delItem}`, { method:"DELETE" }).then(()=>{ loadGlobalItems(); loadUserItems(); }); }
    });
    document.getElementById("btn-create-user").onclick = createUser;
    document.getElementById("btn-load-users").onclick = loadUsers;
    document.getElementById("btn-create-item").onclick = createItem;
    document.getElementById("btn-load-user-items").onclick = loadUserItems;
    document.getElementById("btn-load-items").onclick = loadGlobalItems;

    // ==== INIT ====
    fillHome();
    loadUsers().then(loadGlobalItems).catch(e=>setStatus(e.message));

    const openBtn = document.getElementById('openChat');
    const closeBtn = document.getElementById('closeChat');
    const modal = document.getElementById('chatModal');
    const frame = document.getElementById('chatFrame');

    function chatUrl() {
      // adjust path depending on how you serve static files (default: /static/chat.html)
      return location.origin + '/static/chat.html';
    }

    openBtn.addEventListener('click', () => {
      frame.src = chatUrl();
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');
    });

    closeBtn.addEventListener('click', () => {
      frame.src = 'about:blank';
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
    });

    // close when clicking backdrop (but not when clicking modal content)
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeBtn.click();
    });

    // Esc key to close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.style.display === 'flex') closeBtn.click();
    });
  </script>
</body></body>
</html>
